<!doctype html>
<html style="background-color: #f5f5f5; min-height: 100%;">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">

  <title>Configuring Gems For Opal</title>

  <link href="../../stylesheets/application.css" rel="stylesheet" />
  <link href="http://code.ionicframework.com/ionicons/1.4.1/css/ionicons.min.css" rel="stylesheet" />
  <script src="../../javascripts/application.js"></script>
</head>
<body class="docs docs_configuring_gems docs_configuring_gems_index">
  <nav class='navbar navbar-default opal-nav' role='navigation'>
  <div class='container'>
    <div class='navbar-header'>
      <a class='navbar-brand' href='/'>
        <img height='22' src='http://assets.makersacademy.com/images/logo/ma-white.png' width='44'>
        Makers Academy
      </a>
      <button class='navbar-toggle' data-target='#opal-navbar' data-toggle='collapse' type='button'>
        <span class='icon-bar'></span>
        <span class='icon-bar'></span>
        <span class='icon-bar'></span>
      </button>
    </div>
    <div class='navbar-collapse collapse' id='opal-navbar'>
      <ul class='nav navbar-nav'>
        <li>
          <a href='https://github.com/makersacademy'>
            <i class='ion-social-github'></i>
            GitHub
          </a>
        </li>
      </ul>
    </div>
  </div>
</nav>

  <script>$('a[href="'+location.pathname.replace(/\/$/,'')+'"]').parent().addClass('active')</script>

  <div class="container">
      <div class="container">
    <div class="row">
      <div class="col-sm-12">
        <h1>Configuring Gems For Opal</h1>
      </div>
    </div>
    <div class="row">
      <div class="col-md-4 col-md-push-8">
        <ul class="nav opal-sidebar">
<li class="toc-list-chapter"><a href="#configuring-gems-to-run-everywhere">Configuring Gems To Run Everywhere</a></li>
<li class="toc-list-chapter"><a href="#configuring-gems-to-run-in-opal-only">Configuring Gems To Run In Opal Only</a></li>
<li class="toc-list-chapter"><a href="#testing">Testing</a></li>
<li class="toc-list-chapter"><a href="#conditional-execution">Conditional Execution</a></li></ul>
      </div>

      <div class="col-md-8 col-md-pull-4">
        <p>To configure a gem to run in Opal the gem will need a couple of things:</p>

<ol>
<li>The Opal gem running on a server (so the ruby code can get compiled to .js.)</li>
<li>The Opal search path has to know to look for your gem when it is required.</li>
</ol>

<p>This is done by having the following 2 lines in your outermost .rb file:</p>
<pre class="highlight ruby"><code><span class="nb">require</span> <span class="s1">'opal'</span>
<span class="no">Opal</span><span class="p">.</span><span class="nf">append_path</span> <span class="no">File</span><span class="p">.</span><span class="nf">expand_path</span><span class="p">(</span><span class="s1">'..'</span><span class="p">,</span> <span class="kp">__FILE__</span><span class="p">).</span><span class="nf">untaint</span>
</code></pre>

<p>However it only makes sense to execute these lines outside of Opal, since what they do is set things up for Opal to find and compile the files to .js. So how these lines get added to your gem depends on whether the gem can usefully run in the normal server environment as well as in Opal, or just strictly in Opal.</p>

<p>For example, you have a gem that parses, validates, and gives details on email addresses.  This gem would be just as useful on the server, as running
in the browser.</p>

<p>On the other hand you have a gem that does something with the DOM.  There would be no point in making this gem available to the server.</p>

<p>Each case is detailed below, assuming you have a Gem file structure like this:</p>
<pre class="highlight plaintext"><code>--lib
  |
  --&gt;your_gem_directory
    your_gem_file1.rb
    your_gem_file2.rb
    ...
    version.rb
  your_gem.rb
</code></pre>

<h2 id="configuring-gems-to-run-everywhere">Configuring Gems To Run Everywhere</h2>

<p>If your gem will work both in Opal and in a classic ruby environment
your outer .rb file (<code>your_gem.rb</code>) needs to look like this</p>
<pre class="highlight ruby"><code><span class="c1"># require all the files, regardless of whether this code is running</span>
<span class="c1"># to run on the server, or inside of Opal.</span>
<span class="nb">require_relative</span> <span class="s1">'your_gem_directory/your_gem_file1.rb'</span>
<span class="nb">require_relative</span> <span class="s1">'your_gem_directory/your_gem_file2.rb'</span>
<span class="c1"># etc</span>
<span class="nb">require_relative</span> <span class="s1">'your_gem_directory/version'</span>
<span class="k">unless</span> <span class="no">RUBY_ENGINE</span> <span class="o">==</span> <span class="s1">'opal'</span>
  <span class="c1"># Now if we are NOT running inside of Opal, set things up so Opal can find</span>
  <span class="c1"># the files. The whole thing is rescued in case the Opal gem is not available.</span>
  <span class="c1"># This would happen if the gem is being used server side ONLY.</span>
  <span class="k">begin</span>
    <span class="nb">require</span> <span class="s1">'opal'</span>
    <span class="no">Opal</span><span class="p">.</span><span class="nf">append_path</span> <span class="no">File</span><span class="p">.</span><span class="nf">expand_path</span><span class="p">(</span><span class="s1">'..'</span><span class="p">,</span> <span class="kp">__FILE__</span><span class="p">).</span><span class="nf">untaint</span>
  <span class="k">rescue</span> <span class="no">LoadError</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>

<p>So lets see what happens here.</p>

<ol>
<li>Somebody is going to require this file, perhaps implicitly (for example you are running in rails.)</li>
<li>Standard ruby is going to execute the <code>require</code>s, which will load your gem sources, then</li>
<li>because the <code>RUBY_ENGINE</code> is <em>not</em> Opal, Opal will be required, and your directory of sources added to Opal&#39;s search path.</li>
<li>Someplace else in some Opal code, the gem will <em>again</em> be required, and so Opal searches and finds the gem,</li>
<li>and runs this file again, <em>but now inside</em> of the Opal environment.  This time the <code>RUBY_ENGINE</code> <em>is</em> Opal so the <code>require &#39;opal&#39;</code> etc will not be executed.</li>
</ol>

<p>The result is that you have two versions of the code, one in standard ruby, and a second compiled to .js and ready to be served.</p>

<h2 id="configuring-gems-to-run-in-opal-only">Configuring Gems To Run In Opal Only</h2>

<p>If it makes no sense to run the code in standard ruby (i.e. on the server) then the above code can look like this:</p>
<pre class="highlight ruby"><code><span class="c1"># require all the files, only if Opal is executing</span>
<span class="k">if</span> <span class="no">RUBY_ENGINE</span> <span class="o">==</span> <span class="s1">'opal'</span>
  <span class="nb">require_relative</span> <span class="s1">'your_gem_directory/your_gem_file1.rb'</span>
  <span class="nb">require_relative</span> <span class="s1">'your_gem_directory/your_gem_file2.rb'</span>
  <span class="c1"># etc</span>
  <span class="nb">require_relative</span> <span class="s1">'your_gem_directory/version'</span>
<span class="k">else</span>
  <span class="c1"># NOT running inside of Opal, set things up</span>
  <span class="c1"># so Opal can find the files.</span>
  <span class="nb">require</span> <span class="s1">'opal'</span>
  <span class="no">Opal</span><span class="p">.</span><span class="nf">append_path</span> <span class="no">File</span><span class="p">.</span><span class="nf">expand_path</span><span class="p">(</span><span class="s1">'..'</span><span class="p">,</span> <span class="kp">__FILE__</span><span class="p">).</span><span class="nf">untaint</span>
<span class="k">end</span>
</code></pre>

<h2 id="testing">Testing</h2>

<p>Regardless of which case your gem is designed for, you will want to make sure you test inside the Opal environment.  If nothing else
you will want to make sure you have all the above configuration setup correctly.</p>

<p>To do this add the following to your gemspec:</p>
<pre class="highlight ruby"><code>  <span class="n">spec</span><span class="p">.</span><span class="nf">add_development_dependency</span> <span class="s2">"opal-rspec"</span>
  <span class="n">spec</span><span class="p">.</span><span class="nf">add_development_dependency</span> <span class="s2">"opal"</span>
</code></pre>

<p>Then setup the following in config.ru (assuming your specs are in the /spec directory.)</p>
<pre class="highlight ruby"><code><span class="nb">require</span> <span class="s1">'bundler'</span>
<span class="no">Bundler</span><span class="p">.</span><span class="nf">require</span>

<span class="nb">require</span> <span class="s1">'opal-rspec'</span>
<span class="no">Opal</span><span class="p">.</span><span class="nf">append_path</span> <span class="no">File</span><span class="p">.</span><span class="nf">expand_path</span><span class="p">(</span><span class="s1">'../spec'</span><span class="p">,</span> <span class="kp">__FILE__</span><span class="p">)</span>

<span class="n">run</span> <span class="no">Opal</span><span class="o">::</span><span class="no">Server</span><span class="p">.</span><span class="nf">new</span> <span class="p">{</span> <span class="o">|</span><span class="n">s</span><span class="o">|</span>
  <span class="n">s</span><span class="p">.</span><span class="nf">main</span> <span class="o">=</span> <span class="s1">'opal/rspec/sprockets_runner'</span>
  <span class="n">s</span><span class="p">.</span><span class="nf">append_path</span> <span class="s1">'spec'</span>
  <span class="n">s</span><span class="p">.</span><span class="nf">debug</span> <span class="o">=</span> <span class="kp">false</span>
  <span class="n">s</span><span class="p">.</span><span class="nf">index_path</span> <span class="o">=</span> <span class="s1">'spec/index.html.erb'</span>
<span class="p">}</span>
</code></pre>

<p>Finally create a index.html.erb file in the spec directory with the following contents:</p>
<pre class="highlight html"><code><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html&gt;</span>
<span class="nt">&lt;head&gt;</span>
<span class="nt">&lt;/head&gt;</span>
<span class="nt">&lt;body&gt;</span>
  <span class="err">&lt;</span>%= javascript_include_tag @server.main %&gt;
<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</code></pre>

<p>With all this setup, you can run specs normally to test standard ruby execution, and then do</p>
<pre class="highlight plaintext"><code>bundle exec rackup
</code></pre>

<p>and point your browser to localhost, and you will see your spec results running in the Opal environment.</p>

<p>Don&#39;t forget to checkout the added features of the opal-rspec gem such as async specs.</p>

<h2 id="conditional-execution">Conditional Execution</h2>

<p>In some cases you might have to check whether you are in Opal or not, just wrap the code in:</p>
<pre class="highlight plaintext"><code>if RUBY_ENGINE == 'opal'
  ...
end
</code></pre>

<p>This might happen in your specs or in the actual gem code.</p>

      </div>
    </div>
  </div>

  </div>

  <!-- GOOGLE ANALYTICS -->
<script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-35688734-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>

<footer>
  Powered by <a href="https://github.com/opal/">Opal</a>
</footer>


  <script>
    $('a[href="'+location.pathname.replace(/\/$/,'')+'"]').parent('li').addClass('active')
  </script>
</body>
</html>
